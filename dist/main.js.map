{"version":3,"sources":["main.js"],"names":["global","document","demand","provide","definition","DomElement","DomElementAppear","ComponentSense","functionMerge","functionDebounce","globalOnResize","instance","i","instances","isVisible","localOnResize","call","candidate","image","boundingbox","dimensions","quality","url","self","this","properties","storage","uuid","parent","getParent","candidates","mql","matches","selector","checkSelector","visible","node","getBoundingClientRect","settings","modifier","width","height","ratio","offsetHeight","offsetWidth","scale","devicePixelRatio","replace","matchUrl","Math","round","setAttribute","emit","setRatio","element","match","querySelectorAll","length","processSources","media","sources","getChildren","getAttribute","parseInt","on","push","container","setStyle","Rescale","temp","caption","setStyles","position","display","padding","appendTo","parentNode","src","placeholder","alt","top","left","margin","event","type","min","extends"],"mappings":"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","file":"main.js","sourcesContent":["(function(global, document, demand, provide) {\n\t'use strict';\n\n\tfunction definition(DomElement, DomElementAppear, ComponentSense, functionMerge, functionDebounce) {\n\t\tvar storage     = {},\n\t\t\tinstances   = [],\n\t\t\tmatchUrl    = /(.+?).(jpe?g|png|gif)$/i,\n\t\t\tplaceholder = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=';\n\n\t\tfunction globalOnResize() {\n\t\t\tvar i = 0, instance;\n\n\t\t\tfor(; instance = instances[i]; i++) {\n\t\t\t\tinstance.isVisible() && localOnResize.call(instance);\n\t\t\t}\n\t\t}\n\n\t\tfunction localOnResize() {\n\t\t\tvar self       = this,\n\t\t\t\tproperties = storage[self.uuid],\n\t\t\t\tparent     = self.getParent(),\n\t\t\t\ti = 0, candidate, image, boundingbox, dimensions, quality, url;\n\n\t\t\tfor(; candidate = properties.candidates[i]; i++) {\n\t\t\t\tif((!candidate.mql || candidate.mql.matches) && (!candidate.selector || checkSelector.call(self, candidate.selector))) {\n\t\t\t\t\timage = properties.image;\n\n\t\t\t\t\tif(properties.visible) {\n\t\t\t\t\t\tboundingbox = image.node.getBoundingClientRect();\n\t\t\t\t\t\tdimensions  = properties.settings.modifier({\n\t\t\t\t\t\t\twidth:  boundingbox.width,\n\t\t\t\t\t\t\theight: boundingbox.width * (candidate.ratio || properties.ratio || parent.offsetHeight / parent.offsetWidth),\n\t\t\t\t\t\t\tscale:  (global.devicePixelRatio || 1) * 100\n\t\t\t\t\t\t});\n\t\t\t\t\t\tquality     = candidate.quality || properties.quality;\n\t\t\t\t\t\turl         = candidate.url.replace(matchUrl, '$1.' + Math.round(dimensions.width) + 'x' + Math.round(dimensions.height) + '@' + Math.round(dimensions.scale) + (quality ? '.' + quality : '') + '.$2');\n\n\t\t\t\t\t\timage\n\t\t\t\t\t\t\t.setAttribute('src', url)\n\t\t\t\t\t\t\t.emit('rescale', candidate.url, url);\n\t\t\t\t\t}\n\n\t\t\t\t\tsetRatio.call(self, candidate.ratio);\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsetRatio.call(self);\n\t\t}\n\n\t\tfunction checkSelector(selector) {\n\t\t\tvar self    = this,\n\t\t\t\tmatches = document.querySelectorAll(selector),\n\t\t\t\telement, i, match;\n\n\t\t\tif(matches.length) {\n\t\t\t\telement = self.node;\n\n\t\t\t\tfor(i = 0; match = matches[i]; i++) {\n\t\t\t\t\tif(match === element) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn self.getParent(selector);\n\t\t}\n\n\t\tfunction processSources() {\n\t\t\tvar self       = this,\n\t\t\t\tsources    = self.getChildren('[itemprop=\"contentUrl\"]'),\n\t\t\t\tcandidates = [],\n\t\t\t\ti = 0, candidate, width, height, ratio, media;\n\n\t\t\tfor(; candidate = sources[i]; i++) {\n\t\t\t\twidth  = (width = candidate.getAttribute('width')) ? parseInt(width) : null;\n\t\t\t\theight = (height = candidate.getAttribute('height')) ? parseInt(height) : null;\n\t\t\t\tratio  = (width && height) ? height / width : null;\n\t\t\t\tmedia  = (media = candidate.getAttribute('media')) ? new ComponentSense(media).on('match unmatch', function() { localOnResize.call(self); }) : null;\n\n\t\t\t\tcandidates.push({\n\t\t\t\t\turl:      candidate.getAttribute('content'),\n\t\t\t\t\tratio:    ratio,\n\t\t\t\t\tquality:  candidate.getAttribute('quality'),\n\t\t\t\t\tmql:      media,\n\t\t\t\t\tselector: candidate.getAttribute('selector')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn candidates;\n\t\t}\n\n\t\tfunction setRatio(ratio) {\n\t\t\tvar self       = this,\n\t\t\t\tproperties = storage[self.uuid],\n\t\t\t\tparent     = properties.parent;\n\n\t\t\tproperties.container.setStyle('paddingBottom', ((ratio || properties.ratio || parent.offsetHeight / parent.offsetWidth) * 100) + '%');\n\n\t\t\treturn self;\n\t\t}\n\n\t\tfunction Rescale(element, settings) {\n\t\t\tvar self = DomElementAppear.call(this, element, settings),\n\t\t\t\tuuid = self.uuid,\n\t\t\t\ttemp, parent, container, width, height, quality, caption, properties;\n\n\t\t\tparent     = self.getParent();\n\t\t\tcontainer  = new DomElement('<div />').setStyles({ position: 'relative', display: 'block', width: '100%', height: 0, padding: 0 }).appendTo(self);\n\t\t\twidth      = (temp = self.getChildren('[itemprop=\"width\"]')[0]) ? parseInt(temp.getAttribute('content')) : null;\n\t\t\theight     = (temp = self.getChildren('[itemprop=\"height\"]')[0]) ? parseInt(temp.getAttribute('content')) : null;\n\t\t\tquality    = (temp = self.getChildren('[itemprop=\"quality\"]')[0]) ? parseInt(temp.getAttribute('content')) : null;\n\t\t\tcaption    = (temp = self.getChildren('[itemprop=\"caption\"]')[0]) ? temp.getAttribute('content') : null;\n\n\t\t\twhile(parent.offsetHeight === 0) {\n\t\t\t\tparent = parent.parentNode;\n\t\t\t}\n\n\t\t\tproperties = storage[uuid] = {\n\t\t\t\tvisible:    false,\n\t\t\t\tsettings:   functionMerge({}, Rescale.settings, settings),\n\t\t\t\tratio:      (width && height) ? height / width : null,\n\t\t\t\tquality:    quality,\n\t\t\t\tparent:     parent,\n\t\t\t\tcontainer:  container,\n\t\t\t\timage:      new DomElement('<img />', { src: placeholder, alt: caption || '' }, { position: 'absolute', display: 'block', width: '100%', height: '100%', top: '0', left: '0', margin: '0', padding: '0' }).appendTo(container),\n\t\t\t\tcandidates: processSources.call(self),\n\t\t\t\tcaption:    caption\n\t\t\t};\n\n\t\t\tinstances.push(self);\n\n\t\t\treturn setRatio\n\t\t\t\t.call(self)\n\t\t\t\t.on('appear disappear', function(event) {\n\t\t\t\t\tproperties.visible = (event.type === 'appear');\n\n\t\t\t\t\tlocalOnResize.call(self);\n\t\t\t\t});\n\t\t}\n\t\t\n\t\tRescale.settings = {\n\t\t\tmodifier: function(dimensions) {\n\t\t\t\t/*\n\t\t\t\t var ratio = dimensions.height / dimensions.width;\n\t\t\t\t \n\t\t\t\t dimensions.width  = Math.ceil(dimensions.width / 50) * 50;\n\t\t\t\t dimensions.height = dimensions.width * ratio;\n\t\t\t\t */\n\t\t\t\tdimensions.scale  = Math.min(200, dimensions.scale);\n\t\t\t\t\n\t\t\t\treturn dimensions;\n\t\t\t}\n\t\t};\n\t\t\n\t\tnew DomElement(global)\n\t\t\t.on('resize orientationchange', functionDebounce(globalOnResize));\n\t\t\n\t\treturn Rescale.extends(DomElementAppear);\n\t}\n\n\tprovide([ '/nucleus/dom/element', '/nucleus/dom/element/appear', '/nucleus/component/sense', '/nucleus/function/merge', '/nucleus/function/debounce' ], definition);\n}(this, document, demand, provide));"]}